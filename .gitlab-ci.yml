include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/osu-micro-benchmarks:$CI_COMMIT_SHA

build:
    extends: .container-builder
    stage: build
    variables:
      DOCKERFILE: docker/Dockerfile
      CSCS_REBUILD_POLICY: if-not-exists

test osu:
  extends: .container-runner-hohgant-cpu
  stage: run
  image: $CSCS_REGISTRY_PATH/osu-micro-benchmarks:$CI_COMMIT_SHA
  script:
    - ls -alh /opt/view/bin
    - osu_latency
    - osu_bw
  variables:
    SLURM_JOB_NUM_NODES: 1
    SLURM_NTASKS: 2
    SLURM_CPUS_PER_TASK: 8
