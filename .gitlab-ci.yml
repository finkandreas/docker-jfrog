include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.cscs.yml'


stages:
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: ${CI_PROJECT_NAME}:1.0

build:
    tags:
      - docker_jfrog
    stage: build
    image: art.cscs.ch/cray-ccpe/cray/ccpe-devel-sles15sp2-x86_64:21.09-101921
    before_script:
      - echo "before_script start"
      - cat /etc/os-release
      - echo "before_script done"
    script:
      - echo "script start"
      - cat /etc/os-release
      - CC --version
      - echo "script end"
    after_script:
      - echo "after_script start"
      - cat /etc/os-release
      - echo "after_script end"

run:
  extends: .daint
  stage: run
  # TODO: hard-coded path to the artifactory base-path. This should be changed, where the sarus-runner would use the same default path as the builder-runner pushes to
  image: art.cscs.ch/contbuild/testing/anfink/${PERSIST_IMAGE_NAME}
  script:
    - /opt/hello/bin/hello
  variables:
    PULL_IMAGE: 'YES'
    CSCS_REGISTRY_LOGIN: 'YES'
    SLURM_JOB_NUM_NODES: 2
    SLURM_PARTITION: normal
    SLURM_NTASKS: 2
