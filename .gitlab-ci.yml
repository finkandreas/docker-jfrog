include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:1.0

build:
    extends: .container-builder
    stage: build
    variables:
      DOCKERFILE: docker/Dockerfile
      CSCS_REBUILD_POLICY: always

run container:
  stage: run
  tags: [clariden-container-runner]
  image: $PERSIST_IMAGE_NAME
  variables:
    PULL_IMAGE: 'YES'
    SLURM_PARTITION: amdgpu
  script:
    - pwd
    - ls -alh
    - hostname
    - cat /etc/os-release

run baremetal slurm:
  stage: run
  tags: [clariden-slurm-baremetal]
  variables:
    SLURM_PARTITION: nvgpu
  script:
    - pwd
    - ls -alh
    - env | grep SLURM_
    - hostname
    - cat /etc/os-release

run baremetal:
  stage: run
  tags: [clariden-login-baremetal]
  script:
    - pwd
    - ls -alh
    - hostname
    - cat /etc/os-release
