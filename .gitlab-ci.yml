include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/subdirectory/my_cool_image:1.0

build:
  tags: [rosa-k8s]
  image: quay.io/podman/stable:latest
  script:
    - echo "Running with public IP address $(curl -s ifconfig.me)"
    - podman login -u $CSCS_REGISTRY_USER -p $CSCS_REGISTRY_PASSWORD $CSCS_REGISTRY
    - env
    - ls -lh $SSH_KEYFILE
    - 'podman build
       -f $DOCKERFILE
       -t $PERSIST_IMAGE_NAME
       --format docker
       --layers
       --isolation chroot
       --build-arg NUM_PROCS=$(echo "$(cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us) $(cat /sys/fs/cgroup/cpu/cpu.cfs_period_us) $(nproc)" | awk ''{ print ($1/$2 > 0) ? int($1/$2+0.5) : $3; }'')
       --build-arg CSCS_REGISTRY_PATH=$CSCS_REGISTRY_PATH
       --ssh default=$SSH_KEYFILE
       --cache-from $CSCS_REGISTRY_PATH/podman_cache
       --cache-to $CSCS_REGISTRY_PATH/podman_cache
       --cache-ttl=600h .'
    - podman push $PERSIST_IMAGE_NAME
  stage: build
  variables:
    DOCKERFILE: docker/Dockerfile.ubuntu

run:
  extends: .container-runner-hohgant
  stage: run
  image: ${PERSIST_IMAGE_NAME}
  script:
    - /opt/hello/bin/hello
  variables:
    USE_MPI: 'YES'
    SLURM_JOB_NUM_NODES: 2
    SLURM_PARTITION: normal
    SLURM_NTASKS: 2

# clone:
#   tags: ['docker_jfrog']
#   stage: run
#   script:
#     - 'true'
#   when: manual
#   variables:
#     CLONE_IMAGE_NAME: finkandreas/skopeo_copy_test:1.0
#     CLONE_REGISTRY_USER: finkandreas
#     RUNNER_MODE: CLONE_IMAGE
