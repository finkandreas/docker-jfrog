include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build_base
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:${CI_COMMIT_SHORT_SHA}

build base:
  extends: .container-builder-dynamic-name
  stage: build_base
  variables:
    DOCKERFILE: docker/Dockerfile.base
    WATCH_FILECHANGES: $DOCKERFILE
    PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/base/base_image

build:
  extends: .container-builder
  stage: build
  variables:
    DOCKERFILE: docker/Dockerfile
    DOCKER_BUILD_ARGS: '["BASE_IMG=$BASE_IMAGE"]'

run vial:
  tags: ['vial-spack-stack-builder']
  stage: run
  script:
    - ls -alh $SCRATCH
    - ls -alh
    - pwd
    - hostname
    - env
  variables:
    SLURM_JOB_NUM_NODES: 1

      #run:
      #  tags: ['f7t-runner']
      #  stage: run
      #  image: ${PERSIST_IMAGE_NAME}
      #  script:
      #    - /opt/hello/bin/hello
      #  variables:
      #    SLURM_JOB_NUM_NODES: 2
      #    SLURM_PARTITION: debug
      #    SLURM_NTASKS: 2
      #    PULL_IMAGE: 'YES'
      #    GIT_STRATEGY: 'fetch'
      #    SLURM_TIMELIMIT: '00:15:00'
      #    SLURM_CONSTRAINT: mc
      #    FIRECREST_SYSTEM: 'eiger'
      #    MODE: 'container-runner'
      #    USE_MPI: 'YES'
      #    SLURM_ACCOUNT: 'csstaff'
      #
      #run 2:
      #  tags: ['f7t-runner']
      #  stage: run
      #  script:
      #    - ls -alh $SCRATCH
      #    - pwd
      #  variables:
      #    SLURM_JOB_NUM_NODES: 1
      #    SLURM_PARTITION: debug
      #    SLURM_NTASKS: 1
      #    GIT_STRATEGY: 'fetch'
      #    SLURM_TIMELIMIT: '00:15:00'
      #    SLURM_CONSTRAINT: mc
      #    FIRECREST_SYSTEM: 'eiger'
      #    MODE: 'baremetal'
      #    SLURM_ACCOUNT: 'csstaff'
