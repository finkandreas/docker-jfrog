include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext-devel.yml'

stages:
  - build_base
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:${CI_COMMIT_SHORT_SHA}

  #build base:
  #  extends: [.container-builder-cscs-zen2, .dynamic-image-name]
  #  stage: build_base
  #  variables:
  #    DOCKERFILE: docker/Dockerfile.base
  #    WATCH_FILECHANGES: $DOCKERFILE
  #    PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/base/base_image
  #
  #build:
  #  extends: .container-builder
  #  stage: build
  #  variables:
  #    DOCKERFILE: docker/Dockerfile
  #    DOCKER_BUILD_ARGS: '["BASE_IMG=$BASE_IMAGE"]'


run:
  extends: .f7t-reframe-runner
  tags: [f7t-runner-tds]
  stage: run
  before_script:
    - git clone -b alps https://github.com/eth-cscs/cscs-reframe-tests
    - pip install -r cscs-reframe-tests/config/utilities/requirements.txt
    - sed -i -e "s/account=csstaff/account=$CSCS_CI_DEFAULT_SLURM_ACCOUNT/" cscs-reframe-tests/config/systems-firecrest/eiger.py
  after_script:
    - ls --recursive
  variables:
    CSCS_GLR_F7T_IMPL: registry.gitlab.com/cscs-ci/ci-testing/webhook-ci/mirrors/1577408848687868/5855000443724573/glr-f7t-impl:ed0dd4d4
    CSCS_GLR_F7T_URL_PREFIX: /citest/glr_f7t
    FIRECREST_SYSTEM: 'eiger'
    FIRECREST_BASEDIR: /capstor/scratch/cscs/jenkssl/reframe-runner
    RFM_FIRECREST: '1'
    RFM_CONFIG: cscs-reframe-tests/config/cscs.py
    RFM_CHECKPATH: cscs-reframe-tests/checks/microbenchmarks/mpi/halo_exchange

  #run:
  #  extends: .container-runner-eiger-mc-f7t
  #  tags: [f7t-runner-tds]
  #  stage: run
  #  image: ${PERSIST_IMAGE_NAME}
  #  script:
  #    - /opt/hello/bin/hello
  #  variables:
  #    SLURM_JOB_NUM_NODES: 2
  #    SLURM_PARTITION: debug
  #    SLURM_NTASKS: 2
  #    GIT_STRATEGY: 'fetch'
  #    USE_MPI: 'YES'
  #    CSCS_GLR_F7T_IMPL: registry.gitlab.com/cscs-ci/ci-testing/webhook-ci/mirrors/1577408848687868/5855000443724573/glr-f7t-impl:e8f68741
  #    CSCS_WSS_GLR_PREFIX: /citest/glr_f7t
