include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.cscs.yml'


stages:
  - build
  - run

build:
    tags:
      - docker_jfrog
    stage: build
    image: ubuntu:20.04
    script:
      - apt-get update
      - env DEBIAN_FRONTEND=noninteractive TZ=Europe/Zurich apt-get -yqq install --no-install-recommends build-essential cmake
      - mkdir build
      - cd build
      - cmake -DCMAKE_INSTALL_PREFIX=/opt/hello ..
      - make -j2
      - make install

run:
  extends: .daint
  stage: run
  image: art.cscs.ch/contbuild/testing/anfink/${CI_PROJECT_NAME}:1.0
  script:
    - /opt/hello/bin/hello
  variables:
    PULL_IMAGE: 'YES'
    CSCS_REGISTRY_LOGIN: 'YES'
    SLURM_JOB_NUM_NODES: 2
    SLURM_PARTITION: normal
    SLURM_NTASKS: 2
