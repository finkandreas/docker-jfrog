include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:1.0

build:
    tags: [minikube-anfink-laptop]
    stage: build
    image:
      name: gcr.io/kaniko-project/executor:debug
      entrypoint: [""]
    script:
      - mkdir -p /kaniko/.docker
      - echo "{\"auths\":{\"${CSCS_REGISTRY}\":{\"auth\":\"$(printf "%s:%s" "${CSCS_REGISTRY_USER}" "${CSCS_REGISTRY_PASSWORD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
      - /kaniko/executor --context "${CI_PROJECT_DIR}" --dockerfile "${CI_PROJECT_DIR}/${DOCKERFILE}" --destination ${PERSIST_IMAGE_NAME}

# run:
#   extends: .container-runner-muttler
#   stage: run
#   image: ${PERSIST_IMAGE_NAME}
#   script:
#     - /opt/hello/bin/hello
#   variables:
#     SLURM_JOB_NUM_NODES: 2
#     SLURM_PARTITION: normal
#     SLURM_NTASKS: 2
