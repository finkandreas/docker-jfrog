include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext-devel.yml'

stages:
  - build_base
  - build
  - run

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:${CI_COMMIT_SHORT_SHA}

  #build base:
  #  extends: [.container-builder-cscs-zen2, .dynamic-image-name]
  #  stage: build_base
  #  variables:
  #    DOCKERFILE: docker/Dockerfile.base
  #    WATCH_FILECHANGES: $DOCKERFILE
  #    PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/base/base_image
  #
  #build:
  #  extends: .container-builder
  #  stage: build
  #  variables:
  #    DOCKERFILE: docker/Dockerfile
  #    DOCKER_BUILD_ARGS: '["BASE_IMG=$BASE_IMAGE"]'


run:
  extends: .f7t-runner
  tags: [f7t-runner-tds]
  stage: run
  script:
    - set -x
    - echo -e "#!/bin/bash\n\nhostname | grep nid" > script.sh
    - SUBMISSION="$(firecrest submit --raw --system eiger --account $CSCS_CI_DEFAULT_SLURM_ACCOUNT script.sh)"
    - echo "$SUBMISSION"
    - JOBID=$(echo "$SUBMISSION" | grep "jobid" | sed -e 's/.*jobid[^0-9]*\([0-9]\+\),/\1/')

    - |
      while firecrest poll-active --raw --system eiger | grep $JOBID ; do
        echo "job is still in queue/running"
        sleep 30
      done
  variables:
    CSCS_GLR_F7T_IMPL: registry.gitlab.com/cscs-ci/ci-testing/webhook-ci/mirrors/1577408848687868/5855000443724573/glr-f7t-impl:00b7475f
    CSCS_GLR_F7T_URL_PREFIX: /citest/glr_f7t
    MODE: 'f7t-controller'

  #run:
  #  extends: .container-runner-eiger-mc-f7t
  #  tags: [f7t-runner-tds]
  #  stage: run
  #  image: ${PERSIST_IMAGE_NAME}
  #  script:
  #    - /opt/hello/bin/hello
  #  variables:
  #    SLURM_JOB_NUM_NODES: 2
  #    SLURM_PARTITION: debug
  #    SLURM_NTASKS: 2
  #    GIT_STRATEGY: 'fetch'
  #    USE_MPI: 'YES'
  #    CSCS_GLR_F7T_IMPL: registry.gitlab.com/cscs-ci/ci-testing/webhook-ci/mirrors/1577408848687868/5855000443724573/glr-f7t-impl:e8f68741
  #    CSCS_WSS_GLR_PREFIX: /citest/glr_f7t
