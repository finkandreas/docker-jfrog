include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext-devel.yml'

stages:
  - run

#test:
#  extends: .container-runner-daint-gh200
#  stage: run
#  image: docker.io/ubuntu:24.04
#  script:
#    - env | grep -iv token
#    - cat /etc/os-release

#test:
#  extends: .baremetal-runner-santis-gh200
#  stage: run
#  script:
#    - uenv repo create || true
#    - uenv image pull prgenv-gnu/24.11:v1
#    - env | grep SLURM_
#    - srun --uenv=prgenv-gnu/24.11:v1 bash -c 'hostname ; env | grep SLURM_ ; srun -n 288 --threads-per-core=1 --distribution=block:block:block hostname'
#  variables:
#    GIT_STRATEGY: none
#    SLURM_TIMELIMIT: '00:20:00'
#    SLURM_PARTITION: debug

#test:
#  tags: [zinal-login-baremetal]
#  stage: run
#  script:
#    - hostname
#    - pwd
#    - env

test:
  extends: .container-builder-cscs-gh200
  stage: run
  timeout: 1h
  tags: [languard-k8s-development]
  script:
    - env | grep -i proxy
    - build_new_container
  variables:
    DOCKERFILE: docker/Dockerfile.test
    PERSIST_IMAGE_NAME: discard

test lightweight aarch64:
  tags: [languard-k8s-lightweight-gh200]
  image: opensuse/leap:15.5
  stage: run
  script:
    - zypper install -y skopeo tar gzip wget gcc make
    - cp /usr/bin/skopeo /hostdir/skopeo.$ARCH
    - wget -O empty.tgz https://sourceforge.net/projects/empty/files/latest/download
    - tar -xf empty.tgz
    - cd empty-*
    - make
    - mv empty /hostdir/empty.$ARCH"
  variables:
    ARCH: aarch64
    KUBERNETES_CPU_REQUEST: "1"
    KUBERNETES_CPU_LIMIT: "1"
    KUBERNETES_MEMORY_REQUEST: "1Gi"
    KUBERNETES_MEMORY_LIMIT: "1Gi"


#test:
#  extends: .container-runner-daint-gh200
#  stage: run
#  image: docker.io/ubuntu:24.04
#  hooks:
#    pre_get_sources_script:
#      - echo "This is from the pre_get_sources_script"
#      - pwd
#  script:
#    - hostname
#    - cat /etc/os-release
#  variables:
#    SLURM_TIMELIMIT: '00:05:00'
#    SLURM_PARTITION: debug

    #test:
    #  extends: .uenv-builder-todi-gh200
    #  stage: run
    #  variables:
    #    UENV_RECIPE: uenv-recipes/prgenv-gnu/24.11/gh200
    #    UENV_NAME: linalg
    #    UENV_VERSION: 24.11
    #    SPACK_DEVELOP: '-d'

  #test uenv run:
  #  extends: .uenv-runner-eiger-zen2
  #  needs: ['test']
  #  stage: run
  #  image: 'prgenv-gnu/24.7:$CI_PIPELINE_ID'
  #  script:
  #    - uenv view develop
  #    - mpic++ --version
