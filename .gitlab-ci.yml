include:
  - remote: 'https://gitlab.com/cscs-ci/recipes/-/raw/master/templates/v2/.ci-ext.yml'

stages:
  - build

variables:
  # CI_PROJECT_NAME==docker-jfrog - 1:0 is the version tag, if you want to tag each run, also use CI_COMMIT_SHA
  PERSIST_IMAGE_NAME: $CSCS_REGISTRY_PATH/my_cool_image:1.0

build:
    tags: [minikube-anfink-laptop]
    stage: build
    image: ubuntu:22.04
    script:
      - cat /proc/cpuinfo
      - cat /sys/fs/cgroup/cpu/cpu.shares
      - cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us
      - cat /sys/fs/cgroup/cpu/cpu.cfs_period_us
      - cat /sys/fs/cgroup/cpuset/cpuset.cpus
      - nproc
      - apt-get update
      - env DEBIAN_FRONTEND=noninteractive TZ=Europe/Zurich apt-get -yqq install --no-install-recommends build-essential cmake
      - python3 -c "import math; a = $(cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us) / $(cat /sys/fs/cgroup/cpu/cpu.cfs_period_us); print(math.ceil(a)) if a>0 else print($(nproc))"
      - mkdir build
      - cd build
      - cmake -DCMAKE_INSTALL_PREFIX=/opt/hello ..
      - make -j2
      - make install

# run:
#   extends: .container-runner-muttler
#   stage: run
#   image: ${PERSIST_IMAGE_NAME}
#   script:
#     - /opt/hello/bin/hello
#   variables:
#     SLURM_JOB_NUM_NODES: 2
#     SLURM_PARTITION: normal
#     SLURM_NTASKS: 2
